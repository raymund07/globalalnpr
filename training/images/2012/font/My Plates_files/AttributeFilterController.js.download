(function($){'use strict';TxDMV.Lpot.MyPlates.Web.Views.AttributeFilterController=function(applicationController){var options;var $me;var $contents;var arrayHelper=TxDMV.Lpot.MyPlates.Web.Services.arrayHelper;var objectHelper=TxDMV.Lpot.MyPlates.Web.Services.objectHelper;var _allAreSelected;function bind(bindOptions){options=bindOptions;setReferences();prepareData();renderData();addHandlers();if(options.selectedAttributes.length>0){var isTitle=typeof options.selectedAttributes==='string';if(isTitle){var selection=options.selectedAttributes.toLowerCase();var titles=$contents.find('.block-title .text').toArray();for(var i=0;i<titles.length;i++){var $title=$(titles[i]);if($title.text().toLowerCase()===selection){$title.click();return;}}}else{options.selectedAttributes.forEach(function(id){var $attribute=$contents.find('.option[data-attributeId="'+id+'"]');$attribute.click();});}}}
function renderData(){var renderTitle=function(name){var $title='<div class="block-title"><span class="text">'+name+'</span></div>';$contents.append($title);};var renderOption=function($list,option){var $option='<li class="option" data-attributeId="'+option.id+'">'+option.name+'</li>';$list.append($option);};var filterAttributesToThoseReferencedByPlates=function(){var attributeLookup=arrayHelper.indexByUniqueProperty(options.attributes,'id');var list={};options.families.forEach(function(family){family.attributes.forEach(function(item){var id=item.id;if(!list[id]){var attribute=attributeLookup[id];if(attribute)list[id]=attribute;}});});return objectHelper.convertToArray(list);};var referencedAttributes=filterAttributesToThoseReferencedByPlates();arrayHelper.sort(referencedAttributes,['attributeTypeSortOrder','sortOrder','name']);var lastType='';var $list;referencedAttributes.forEach(function(item){if(item.attributeType!==lastType){renderTitle(item.attributeType);lastType=item.attributeType;$list=new $('<ul class="options">');$contents.append($list);}
renderOption($list,item);});renderTitle("Discontinued");$list=new $('<ul class="options">');$contents.append($list);$list.append('<li class="discontinued-link"><a href="/discontinued-plates">Discontinued Plates</li>');}
function setReferences(){$me=options.$container;$contents=$me.find('.contents');}
function prepareData(){var denormalizeFilterOptions=function(){var attributeTypeLookup=arrayHelper.indexByUniqueProperty(options.attributeTypes,'id');options.attributes.forEach(function(item){var type=attributeTypeLookup[item.attributeTypeId];item.attributeType=(type)?type.name:'{Unknown}';item.attributeTypeSortOrder=(type)?type.sortOrder:999999;});};denormalizeFilterOptions();}
function addHandlers(){addOptionsTitleHandler();addOptionClickHandler();}
function addOptionsTitleHandler(){var onClick=function($target){var $options=$target.next().children();var shouldSelect=!allAreSelected($options);selectAll($options,shouldSelect);};var selectAll=function($options,shouldSelect){$options.toArray().forEach(function(item){var $item=$(item);var isSelected=$item.hasClass('selected');var shouldClick=(shouldSelect&&!isSelected)||(!shouldSelect&&isSelected);if(shouldClick)$item.click();});};var onMouseEnter=function($target){var $options=$target.next().children();var className=(allAreSelected($options))?'provisionally-unselected':'provisionally-selected';$options.addClass(className);};var onMouseLeave=function($target){var $options=$target.next().children();$options.removeClass('provisionally-selected provisionally-unselected');};var allAreSelected=function($options){var $list=$($options[0]).parent();var $selected=$list.find('.selected');return($selected.length===$options.length);};applicationController.on($me,'click','.wrapper:not(.disabled) .block-title',onClick);applicationController.on($me,'mouseenter','.wrapper:not(.disabled) .block-title',onMouseEnter);applicationController.on($me,'mouseleave','.wrapper:not(.disabled) .block-title',onMouseLeave);}
function addOptionClickHandler(){var onClick=function($target){$target.toggleClass('selected');var data={attributeId:$target.attr('data-attributeId'),name:$target.text(),isSelected:$target.hasClass('selected')};if(options.onChanged)options.onChanged(data);};applicationController.on($me,'click','.wrapper:not(.disabled) .option',onClick);}
function enable(isEnabled){var action=(isEnabled)?'removeClass':'addClass';$me.find('> .wrapper')[action]('disabled');}
function selectAttribute(attributeId,isSelected){isSelected=(isSelected==null)?true:isSelected;var $option=$contents.find('.option[data-attributeId="'+attributeId+'"]');if(isSelected===$option.hasClass('selected'))return;$option.click();}
function getSelectedAttributeIds(){var list=[];var items=$contents.find('.option.selected').toArray();if(items.length===0){items=$contents.find('.option').toArray();_allAreSelected=true;}else{_allAreSelected=false;}
items.forEach(function(item){var id=parseInt($(item).attr('data-attributeId'));list.push(id);});return list;}
return{bind:bind,enable:enable,select:selectAttribute,getSelectedAttributeIds:getSelectedAttributeIds,isAll:function(){return _allAreSelected;}};};}(jQuery));