(function($,applicationController){'use strict';var $me;var $orderButton;var _vehicleTypes;var _plates;var _plateLookup;var _selectedPlateParameters;var _browserTabTitle='My Plates';var _blankImageFileName='blank.png';var _imageRootUrl='https://myplates.azureedge.net/plates/';var _plateIsAvailable=false;var _licensePlateRepository;var _characterSvgService;var _attributeFilterController;var _filterStatusController;var _messageEditorController;var _microPlatesController;var _searchController;var _plateRenderingService;var _urlService;var _designTypeId_Personalized=1;var _designTypes=[{id:1,name:'Personalized',seoName:'personalized'},{id:2,name:'Background Only',seoName:'background'}];var _qualifyingPlateCategories=[{id:11,name:'Qualifying State Plate'},{id:12,name:'Personalized Qualifying State Plate'}];var _missingAttributeType={id:0,name:'Misc',description:'Miscellaneous',sortOrder:9999999};var _missingAttribute={id:0,name:'Misc',description:'Miscellaneous',sortOrder:9999999,attributeTypeId:0};var arrayHelper=TxDMV.Lpot.MyPlates.Web.Services.arrayHelper;var objectHelper=TxDMV.Lpot.MyPlates.Web.Services.objectHelper;var _startTime=performance.now();function writeElapsedMilliseconds(text,startTime){var timeDiff=performance.now()-startTime;if(false)console.log(text+' '+Math.round(timeDiff)+'ms');}
function load(){var data=TxDMV.Lpot.MyPlates.Web.Data;var services=TxDMV.Lpot.MyPlates.Web.Services;var views=TxDMV.Lpot.MyPlates.Web.Views;_licensePlateRepository=new data.LicensePlateRepository(applicationController);_characterSvgService=new services.CharacterSvgService();_attributeFilterController=new views.AttributeFilterController(applicationController);_filterStatusController=new views.FilterStatusController(applicationController);_messageEditorController=new views.MessageEditorController(applicationController);_microPlatesController=new views.MicroPlatesController(applicationController);_searchController=new views.SearchController(applicationController);_urlService=new views.UrlService(applicationController);var itemsToLoad=['/api/vehicletypes','/api/attributetypes','/api/attributes','/api/microplatedata','/api/familiesmetadata',_licensePlateRepository.loadAsync(),_characterSvgService.loadAsync()];applicationController.whenDone(itemsToLoad,bind);}
function bind(vehicleTypes,attributeTypes,attributes,microplateData,familiesMetadata){_vehicleTypes=arrayHelper.sort(vehicleTypes,'sortOrder');_plateRenderingService=new TxDMV.Lpot.MyPlates.Web.Services.LicensePlateMessageSvgService(_characterSvgService,_licensePlateRepository);writeElapsedMilliseconds('load',_startTime);initializeUrlService(microplateData);prepareData(attributeTypes,attributes,microplateData,familiesMetadata);setReferences();setInitialUIState();bindMessageEditor();bindFilterStatus();bindMicroPlates(attributeTypes,attributes);bindAttributeFilter(attributeTypes,attributes,microplateData);bindSearchBox();addHandlers();onFilterChange();_messageEditorController.raiseMessageChanged();_messageEditorController.checkAvailability();}
function initializeUrlService(microplateData){var options={designTypes:_designTypes,vehicleTypes:_vehicleTypes,microplateData:microplateData,browserTabTitle:_browserTabTitle};_urlService.init(options);}
function setInitialUIState(){$me.find('.vehicle-type-button-wrapper *[data-id="'+_selectedPlateParameters.vehicleTypeId+'"]').addClass('active');if(_selectedPlateParameters.designTypeId!==_designTypeId_Personalized)$me.find('.filtered-plates').addClass('background-only');}
function bindAttributeFilter(attributeTypes,attributes,microplateData){var startTime=performance.now();var options={$container:$me.find('.attribute-filter'),selectedAttributes:_selectedPlateParameters.attributes,attributes:attributes,attributeTypes:attributeTypes,families:microplateData,onChanged:onAttributeFilterChanged};_attributeFilterController.bind(options);writeElapsedMilliseconds('bindAttributeFilter',startTime);}
function bindFilterStatus(){var options={$container:$me.find('.filter-status'),onClearSearch:function(){_searchController.clear();},onRemoveAttribute:function(attributeId){_attributeFilterController.select(attributeId,false);}};_filterStatusController.bind(options);}
function bindMessageEditor(){var startTime=performance.now();var options={$container:$me.find('.message-editor'),message:_selectedPlateParameters.message,imageRootUrl:_imageRootUrl,blankImageFileName:_blankImageFileName,plateRenderingService:_plateRenderingService,onMessageChanged:onMessageChanged,onAvailabilityChanged:onAvailabilityChanged,getPlateParameters:function(){return _selectedPlateParameters;}};_messageEditorController.bind(options);writeElapsedMilliseconds('bindMessageEditor',startTime);var featuredPlate=_urlService.getPlate(_selectedPlateParameters);onPlateSelected(featuredPlate);}
function bindMicroPlates(attributeTypes,attributes){var startTime=performance.now();var options={$container:$me.find('.filtered-plates'),attributes:attributes,imageRootUrl:_imageRootUrl,blankImageFileName:_blankImageFileName,personalizedDesignTypeId:_designTypeId_Personalized,attributeTypes:attributeTypes,qualifyingPlateCategories:_qualifyingPlateCategories,plates:_plates,plateLookup:_plateLookup,onSelected:function(plate){onPlateSelected(plate,true);}};_microPlatesController.bind(options);writeElapsedMilliseconds('bindMicroPlates',startTime);}
function bindSearchBox(){var options={term:_selectedPlateParameters.searchString,$container:$me.find('.plate-search'),onChange:onSearchChanged};_searchController.bind(options);}
function prepareData(attributeTypes,attributes,microplateData,familiesMetadata){var denormalizePlates=function(){setFamilyVehicleTypeValues();_plateLookup={};var metadataLookup=arrayHelper.indexByUniqueProperty(familiesMetadata,'familyId');var list=[];microplateData.forEach(function(family){family.searchField=family.name.toLowerCase();var metadata=metadataLookup[family.id];if(metadata)family.searchField+=' '+metadata.metadata.toLowerCase();family.vehicleTypes.forEach(function(plate){_plateLookup[plate.plateCode]=plate;plate.family=family;plate.info=createInfoText(plate);arrayHelper.sort(plate.terms,'term');if(!family.attributes)family.attributes=[];if(family.attributes.length===0)family.attributes.push({id:_missingAttribute.id});if(!family.availableVehicleTypes)family.availableVehicleTypes=[];if(family.availableVehicleTypes.indexOf(plate.vehicleTypeId)==-1)family.availableVehicleTypes.push(plate.vehicleTypeId);list.push(plate);});});return arrayHelper.sort(list,['family','vehicleTypeId']);};var setFamilyVehicleTypeValues=function(){var lookup={};microplateData.forEach(function(family){family.hasPersonalizedPlate=false;family.hasBackgroundOnlyPlate=false;family.vehicleTypes.forEach(function(plate){if(plate.maxCharacterLength>0){family.hasPersonalizedPlate=true;var key=family.seoName+plate.vehicleTypeId;var familyVehicleType=lookup[key];if(!familyVehicleType){familyVehicleType={maxCharacterLength:plate.maxCharacterLength,minCharacterLength:plate.minCharacterLength,maxByteCount:plate.maxByteCount,plates:[]};lookup[key]=familyVehicleType;}else{familyVehicleType.maxCharacterLength=Math.max(familyVehicleType.maxCharacterLength,plate.maxCharacterLength);familyVehicleType.minCharacterLength=Math.min(familyVehicleType.minCharacterLength,plate.minCharacterLength);familyVehicleType.maxByteCount=Math.max(familyVehicleType.maxByteCount,plate.maxByteCount);}
familyVehicleType.plates.push(plate);}else{family.hasBackgroundOnlyPlate=true;}});});var list=objectHelper.convertToArray(lookup);list.forEach(function(familyVehicleType){familyVehicleType.plates.forEach(function(plate){plate.vehicleTypeMaxCharacterLength=familyVehicleType.maxCharacterLength;plate.vehicleTypeMinCharacterLength=familyVehicleType.minCharacterLength;plate.vehicleTypeMaxByteCount=familyVehicleType.maxByteCount;});});};var createInfoText=function(plate){if(plate.vehicleTypeMaxCharacterLength===0)return'';if(plate.vehicleTypeMinCharacterLength>1){if(plate.vehicleTypeMinCharacterLength===plate.vehicleTypeMaxCharacterLength)return'Exactly '+plate.vehicleTypeMaxCharacterLength+' characters';return plate.vehicleTypeMinCharacterLength+' - '+plate.vehicleTypeMaxCharacterLength+' characters';}
return'Up to '+plate.vehicleTypeMaxCharacterLength+' characters';};var startTime=performance.now();_plates=denormalizePlates();_selectedPlateParameters=_urlService.getSettings();attributeTypes.push(_missingAttributeType);attributes.push(_missingAttribute);writeElapsedMilliseconds('prepareData',startTime);}
function setReferences(){$me=$('.page-content');$orderButton=$me.find('.button-order');}
function addHandlers(){addDesignTypeHandler();addVehicleTypeHandler();addOrderButtonHandler();addSmartPhoneFilterToggling();addBackToTop();}
function addDesignTypeHandler(){var $personalized=$me.find('.personalization-container');var $dmvGuidelines=$me.find('.txdmv-guidelines-wrapper');var $backgroundOnly=$me.find('.background-only-container');var showPersonlized=function(designTypeId){$backgroundOnly.slideUp();$dmvGuidelines.show();$personalized.slideDown(function(){onDesignTypeChanged(designTypeId);});};var showBackgroundOnly=function(designTypeId){$personalized.slideUp();$dmvGuidelines.hide();$backgroundOnly.slideDown(function(){onDesignTypeChanged(designTypeId);});};var onClick=function($target){var designTypeId=parseInt($target.attr('data-id'));var isPersonalized=$target.hasClass('tab-personalized');$target.parent().find('button').removeClass('active');$target.addClass('active');if(isPersonalized){showPersonlized(designTypeId);}
else{showBackgroundOnly(designTypeId);}};var onPersonalizeYourPlateButtonClick=function(){$me.find('.tab-personalized').trigger('click');};applicationController.on($me,'click','.design-container-tabs button:not(.disabled)',onClick);applicationController.on($backgroundOnly,'click','button:not(.disabled)',onPersonalizeYourPlateButtonClick);}
function addVehicleTypeHandler(){var onClick=function($target){$target.parent().find('button').removeClass('active');$target.addClass('active');var vehicleTypeId=parseInt($target.attr('data-id'));setTimeout(function(){onVehicleTypeChanged(vehicleTypeId);},100);};applicationController.on($me,'click','.vehicle-type-button-wrapper button:not(.disabled)',onClick);}
function addOrderButtonHandler(){var onClick=function($target){var isBackgroundOnly=_selectedPlateParameters.designTypeId==2;var message=(isBackgroundOnly?'':'/'+encodeURI(_selectedPlateParameters.message.toLowerCase()));var url='/licenseplate/'+_selectedPlateParameters.vehicleType+'/'+_selectedPlateParameters.plateFamily+message;window.location.href=url;};applicationController.on($me,'click','.button-order.active',onClick);}
function addSmartPhoneFilterToggling(){var onClick=function($target){var action=($target.hasClass('close'))?'hide':'show';$me.find('.attribute-filter')[action]();};applicationController.on($me,'click','.attribute-filter .close',onClick);applicationController.on($me,'click','#viewFiltersButton',onClick);}
function onAttributeFilterChanged(data){_filterStatusController.updateAttribute(data);onFilterChange();}
function onAvailabilityChanged(isAvailable){_plateIsAvailable=isAvailable;setOrderButtonStatus();}
function onDesignTypeChanged(designTypeId){_urlService.setIdProperty('designTypeId',designTypeId,_selectedPlateParameters);_microPlatesController.showPlateDetails(designTypeId==_designTypeId_Personalized);onFilterChange();}
function onVehicleTypeChanged(vehicleTypeId){_urlService.setIdProperty('vehicleTypeId',vehicleTypeId,_selectedPlateParameters);onFilterChange();}
function onMessageChanged(message){_plateIsAvailable=false;_urlService.setMessage(message.text,_selectedPlateParameters);_microPlatesController.setMessageFlags(message);setOrderButtonStatus();}
function onPlateSelected(plate,scrollToTop){var startTime=performance.now();_urlService.setIdProperty('plateFamilyId',plate.family.id,_selectedPlateParameters);var backgroundOnly=(_selectedPlateParameters.designTypeId===2);_messageEditorController.onPlateSelected(plate,backgroundOnly);setDesignTypeAvailability(plate);setVehicleTypeAvailability(plate);if(scrollToTop)scrollTo(0);writeElapsedMilliseconds('onPlateSelected',startTime);}
function onSearchChanged(term){var termExists=term.length>0;_attributeFilterController.enable(!termExists);_filterStatusController.updateSearch(term);onFilterChange();}
function onFilterChange(){var updateMicroplates=function(){var searchString=_searchController.getTerm();var options={designTypeId:_selectedPlateParameters.designTypeId,vehicleTypeId:_selectedPlateParameters.vehicleTypeId,attributeIds:(searchString.length>0)?[]:_attributeFilterController.getSelectedAttributeIds(),searchString:searchString};_urlService.setSearch(options.searchString,_selectedPlateParameters);_urlService.setAttributes(options.attributeIds,_selectedPlateParameters,_attributeFilterController.isAll());_urlService.updateUrl(_selectedPlateParameters);_microPlatesController.show(options);};var startTime=performance.now();var featuredPlate=_urlService.getPlate(_selectedPlateParameters);onPlateSelected(featuredPlate);updateMicroplates();setOrderButtonStatus();writeElapsedMilliseconds('onFilterChange',startTime);}
function setDesignTypeAvailability(plate){var $orderContainer=$me.find('.order-container');var $personalizeButton=$orderContainer.find('.background-only-container .button');var $designTypeTabs=$orderContainer.find('.design-container-tabs');var $personalizedTab=$designTypeTabs.find('.tab-personalized');var action=(plate.family.hasPersonalizedPlate)?'removeClass':'addClass';$personalizedTab[action]('disabled');$personalizeButton[action]('disabled');var text=(plate.family.hasPersonalizedPlate)?'Personalize Your Plate':'Available only in Background Only';$personalizeButton.text(text);}
function setVehicleTypeAvailability(plate){var getAvailableVehicleTypes=function(){var list=[];var vehicleTypeIndex=arrayHelper.indexByUniqueProperty(_vehicleTypes,'id');for(var i=0;i<plate.family.availableVehicleTypes.length;i++){var id=plate.family.availableVehicleTypes[i];list.push(vehicleTypeIndex[id]);}
return arrayHelper.sort(list,'sortOrder');};var createMessage=function(availableVehicleTypes){var message='';for(var i=0;i<availableVehicleTypes.length;i++){if(message.length>0)message+=' and ';message+=availableVehicleTypes[i].name;}
return'Only available in '+message;};var setButtonStates=function($types){var buttons=$types.find('button').toArray();buttons.forEach(function(button){var $button=$(button);var id=parseInt($button.attr('data-id'));var action=(plate.family.availableVehicleTypes.indexOf(id)>-1)?'removeClass':'addClass';$button[action]('disabled');});};var qualifyingPlateCategories=arrayHelper.indexByUniqueProperty(_qualifyingPlateCategories,'id');if(qualifyingPlateCategories[plate.categoryId]){setQualifyingVehicleTypeAvailability(plate);return;}
var $types=$me.find('.vehicle-type-container');var $status=$types.find('.availability-status');var message='&nbsp;';setButtonStates($types);if(plate.family.availableVehicleTypes.length<4)message=createMessage(getAvailableVehicleTypes());$status.html(message);}
function setQualifyingVehicleTypeAvailability(plate){var $types=$me.find('.vehicle-type-container');var $status=$types.find('.availability-status');var buttons=$types.find('button').toArray();buttons.forEach(function(button){var $button=$(button);var id=parseInt($button.attr('data-id'));var action=plate.vehicleTypeId==id?'removeClass':'addClass';$button[action]('disabled');});var message='See order form for vehicle type availability.';$status.html(message);}
function setOrderButtonStatus(){var personalizedPlateHasAvailableMessage=function(){if(_selectedPlateParameters.designTypeId!==1)return true;if(_selectedPlateParameters.message.length===0)return false;return _plateIsAvailable;};if(!personalizedPlateHasAvailableMessage()){$orderButton.removeClass('active');return;}
$orderButton.addClass('active');}
function addBackToTop(){var $backToTop=$me.find('.back-to-top');var $filtersContainer=$me.find('.attribute-filter');var $microPlatesContainer=$me.find('.micro-plates');var prevScrollTop=0;var backToTopActive=false;var onScroll=function(){var scrollTop=$(document).scrollTop();var viewportHeight=$(window).height();var filtersRect=$filtersContainer[0].getBoundingClientRect();var microPlatesRect=$microPlatesContainer[0].getBoundingClientRect();var hasFilters=$filtersContainer.is(':visible');if(hasFilters){if(scrollTop<prevScrollTop&&filtersRect.bottom<0&&!backToTopActive){backToTopActive=true;$backToTop.addClass('active');return;}
if(backToTopActive&&(scrollTop>prevScrollTop||filtersRect.bottom>=0)){backToTopActive=false;$backToTop.removeClass('active');}}else{if(scrollTop<prevScrollTop&&microPlatesRect.top<(viewportHeight*-2)&&!backToTopActive){backToTopActive=true;$backToTop.addClass('active');return;}
if(backToTopActive&&(scrollTop>prevScrollTop||microPlatesRect.top>=(viewportHeight*-2))){backToTopActive=false;$backToTop.removeClass('active');}}
prevScrollTop=scrollTop;};var onClick=function(){scrollTo($microPlatesContainer.offset().top);};$(window).scroll(onScroll);applicationController.on($me,'click','.back-to-top',onClick);}
function scrollTo(topOffset){$('html, body').animate({scrollTop:topOffset},250);}
load();}(jQuery,TxDMV.Lpot.MyPlates.Web.Services.applicationController));