(function($){'use strict';TxDMV.Lpot.MyPlates.Web.Views.MicroPlatesController=function(applicationController){var options;var $me;var arrayHelper=TxDMV.Lpot.MyPlates.Web.Services.arrayHelper;var objectHelper=TxDMV.Lpot.MyPlates.Web.Services.objectHelper;var plateHelper=TxDMV.Lpot.MyPlates.Web.Services.plateHelper;function bind(bindOptions){options=bindOptions;setReferences();addHandlers();}
function show(displayOptions){$me.empty();var plates=determineWhichPlatesToShow(displayOptions);var buckets=bucketPlatesByAttribute(displayOptions,plates);renderBuckets(buckets);addImageLazyLoading();}
function setReferences(){$me=options.$container;}
function determineWhichPlatesToShow(displayOptions){var normalizeSearchParts=function(){var normalizeSearchTerm=function(term){term=removeSuffix(term,'ies',2);term=removeSuffix(term,'es',2);term=removeSuffix(term,'s',2);return term;};var removeSuffix=function(term,suffix,minimumPrefixLength){if(term.length<(suffix.length+minimumPrefixLength))return term;var prefixLength=term.length-suffix.length;if(term.substring(prefixLength)!==suffix)return term;return term.substring(0,prefixLength);};var parts=searchString.split(' ');for(var i=0;i<parts.length;i++){parts[i]=normalizeSearchTerm(parts[i]);}
return parts;};var searchString=displayOptions.searchString.toLowerCase();var searchParts=normalizeSearchParts();var showPersonalized=displayOptions.designTypeId===options.personalizedDesignTypeId;var familyUniquenessLookup={};var list={};var isDesignTypeMatch=function(plate){if(showPersonalized&&plate.maxCharacterLength>0)return true;if(!showPersonalized&&plate.maxCharacterLength===0)return true;return false;};var isVehicleTypeMatch=function(plate){return plate.vehicleTypeId===displayOptions.vehicleTypeId;};var hasAtLeastOneAttribute=function(plate){for(var i=0;i<plate.family.attributes.length;i++){if(displayOptions.attributeIds.indexOf(plate.family.attributes[i].id)>-1)return true;}
return false;};var isSearchMatch=function(plate){for(var i=0;i<searchParts.length;i++){if(plate.family.searchField.indexOf(searchParts[i])===-1)return false;}
return true;};var familyAlreadyExists=function(plate){var addPlate=function(){familyUniquenessLookup[plate.family.id]=plate;return false;};var existingPlate=familyUniquenessLookup[plate.family.id];if(!existingPlate){return addPlate();}else{if(existingPlate.maxCharacterLength>=plate.maxCharacterLength)return true;delete list[existingPlate.plateCode];return addPlate();}};if(isNameSearch(displayOptions)){options.plates.forEach(function(plate){if(isVehicleTypeMatch(plate)&&isDesignTypeMatch(plate)&&!familyAlreadyExists(plate)&&isSearchMatch(plate))list[plate.plateCode]=plate;});}else{var familiesAddedLookup={};options.plates.forEach(function(plate){if(isVehicleTypeMatch(plate)&&isDesignTypeMatch(plate)&&!familyAlreadyExists(plate)&&hasAtLeastOneAttribute(plate)){list[plate.plateCode]=plate;familiesAddedLookup[plate.family.id]=plate.family;}});options.plates.forEach(function(plate){if(hasAtLeastOneAttribute(plate)&&!familiesAddedLookup[plate.family.id]){if(plate.maxLength===0){plate.infoUnavailable='Available in Background Only';}else if(plate.vehicleTypeId===1){plate.infoUnavailable='Available in Passenger';}else if(plate.vehicleTypeId===2){plate.infoUnavailable='Available in Motorcyle';}else if(plate.vehicleTypeId===3){plate.infoUnavailable='Available in Trailer';}else if(plate.vehicleTypeId===4){plate.infoUnavailable='Available in Private Bus';}else{plate.infoUnavailable='Not available in selected options';}
list[plate.plateCode]=plate;familiesAddedLookup[plate.family.id]=plate.family;}else{plate.infoUnavailable=null;}});}
return objectHelper.convertToArray(list);}
function bucketPlatesByAttribute(displayOptions,plates){var attributeLookup=arrayHelper.indexByUniqueProperty(options.attributes,'id');var attributeTypeLookup=arrayHelper.indexByUniqueProperty(options.attributeTypes,'id');var buckets={};var createNewBucket=function(attributeId){var attribute=attributeLookup[attributeId];var name=(attribute)?attribute.name:'Category '+attributeId;var description=(attribute)?attribute.description:'Category '+attributeId;var bucket={name:(description.length>0)?description:name,id:attributeId,sortOrder:getBucketSortOrder(attribute,name),list:[]};buckets[attributeId]=bucket;return bucket;};var getBucketSortOrder=function(attribute,attributeName){if(!attribute)return'zzz'+attributeName;var type=attributeTypeLookup[attribute.attributeTypeId];var typeSortOrder=(type)?type.sortOrder:'zzzz';return padStart(typeSortOrder)+padStart(attribute.sortOrder)+attributeName;};var padStart=function(number){var str='0000000000'+number;return str.substr(-11);};var attributeSectionShouldAppear=function(attributeId){if(isNameSearch(displayOptions))return true;return displayOptions.attributeIds.indexOf(attributeId)>-1;};var sortBucketsAndPlates=function(list){arrayHelper.sort(list,'sortOrder');list.forEach(function(bucket){arrayHelper.sortObjects(bucket.list,'family',['sortOrder','name']);});return list;};plates.forEach(function(item){item.family.attributes.forEach(function(attribute){if(attributeSectionShouldAppear(attribute.id)){var bucket=buckets[attribute.id];if(!bucket)bucket=createNewBucket(attribute.id);bucket.list.push(item);}});});var list=objectHelper.convertToArray(buckets);return sortBucketsAndPlates(list);}
function renderBuckets(buckets){var qualifyingCategoryLookup=arrayHelper.indexByUniqueProperty(options.qualifyingPlateCategories,'id');var getHoverText=function(item){var str=item.family.name;str+=plateHelper.getPricingText(item);return str;};var getCountAttributes=function(item){return'data-max="'+item.vehicleTypeMaxCharacterLength+'" data-min="'+item.vehicleTypeMinCharacterLength+'" data-byte="'+item.vehicleTypeMaxByteCount+'"';};var renderPlate=function(item){var isAvailable=(item.infoUnavailable)?false:true;var info=(isAvailable)?item.info:item.infoUnavailable;var className=(isAvailable)?'selectable':'unavailable';var hoverText=getHoverText(item);var countAttributes=getCountAttributes(item);var $wrapper=$('<div class="plate-wrapper '+className+'" data-plateCode="'+item.plateCode+'" '+countAttributes+' title="'+hoverText+'">');var $plate=$('<div class="plate-image"><img src="'+options.imageRootUrl+options.blankImageFileName+'"></div>');var $info=$('<div class="plate-info"><span class="plate-name" title="'+item.family.name+'">'+item.family.name+'</span><span class="plate-details">'+info+'</span></div>');$wrapper.append($plate).append($info);return $wrapper;};var renderQualifyingPlate=function(item){var hoverText='Switch to passenger vehicle type to see more information about this plate design.';var countAttributes=getCountAttributes(item);var selectable=item.vehicleTypeId==1?'  selectable':' qualifying-plate-not-passenger';var $wrapper=$('<div class="plate-wrapper'+selectable+'" data-plateCode="'+item.plateCode+'" '+countAttributes+' title="'+hoverText+'">');var $plate=$('<div class="plate-image"><img src="'+options.imageRootUrl+options.blankImageFileName+'"></div>');var $info=$('<div class="plate-info"><span class="plate-name" title="'+item.family.name+'">'+item.family.name+'</span></div>');$wrapper.append($plate).append($info);return $wrapper;};var renderPlates=function(plates){var $plates=$('<div class="plate-list"></div>');plates.forEach(function(item){if(qualifyingCategoryLookup[item.categoryId]&&item.vehicleTypeId>1)
$plates.append(renderQualifyingPlate(item));else
$plates.append(renderPlate(item));});return $plates;};if(buckets.length===0)$me.append($('<div class="none">No plates meet your filter criteria</div>'));buckets.forEach(function(bucket){var $title=$('<h3>'+bucket.name+'</h3>');var $list=renderPlates(bucket.list);$me.append($title).append($list);});}
function isNameSearch(displayOptions){return displayOptions.searchString.length>0;}
function addHandlers(){addPlateSelectHandler();}
function addImageLazyLoading(){var watchOnNonPrimaryThread=function(){var onImageLoadErrorHandler='this.onerror=null;this.src=\''+options.imageRootUrl+options.blankImageFileName+'\';';var onScrollIntoView=function(entries){entries.forEach(function(entry){if(entry.isIntersecting){var $item=$(entry.target);var img=$item.find('img');if(img.attr('src').indexOf(options.blankImageFileName)>-1){var plateCode=$item.attr('data-plateCode');var item=options.plateLookup[plateCode];if(item){img.attr('src',options.imageRootUrl+item.template);img.attr('onerror',onImageLoadErrorHandler);}}}});};var areaToMonitor=null;var rootMargin='60px';var threshold=[0];var observer=new IntersectionObserver(onScrollIntoView,{root:areaToMonitor,rootMargin:rootMargin,threshold:threshold});var elements=document.querySelectorAll('.plate-wrapper');elements.forEach(function(element){observer.observe(element);});};var useIe11PolyFill=function(){$('#microPlates .plate-image img').each(function(){if($(this).attr('src').search('blank.png')>-1){var $item=$(this).closest('.plate-wrapper');var plateCode=$item.attr('data-plateCode');var item=options.plateLookup[plateCode];$(this).attr('src',options.imageRootUrl+item.template);}});};if('IntersectionObserver'in window){watchOnNonPrimaryThread();}
else{useIe11PolyFill();}}
function addPlateSelectHandler(){var onClick=function($trigger){$me.find('.plate-wrapper').removeClass('selected');$trigger.addClass('selected');var plateCode=$trigger.attr('data-plateCode');var plate=options.plateLookup[plateCode];if(options.onSelected)options.onSelected(plate);};applicationController.on($me,'click','.plate-wrapper.selectable',onClick);}
function setMessageFlags(message){var $plates=$me.find('.plate-wrapper');$plates.removeClass('message-warning');if(message.characterLength===0)return;$plates.filter(function(){return $(this).attr('data-byte')<message.byteCount;}).addClass('message-warning');$plates.filter(function(){return $(this).attr('data-max')<message.characterLength;}).addClass('message-warning');$plates.filter(function(){return $(this).attr('data-min')>message.characterLength;}).addClass('message-warning');}
function showPlateDetails(shouldShow){var action=(shouldShow)?'removeClass':'addClass';$me[action]('background-only');}
return{bind:bind,show:show,setMessageFlags:setMessageFlags,showPlateDetails:showPlateDetails};};}(jQuery));