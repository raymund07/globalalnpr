var expand = true;

function expandToggle(){
    if(expand){
        $("#videoFrame").removeClass('col-md-10');
        $("#videoFrame").addClass('col-md-12');
        $("#infoFrame").removeClass('col-md-2');
        $("#infoFrame").hide();
        $("#arrowRight").hide();
        $("#arrowLeft").show();
        expand = false;
    } else {
        $("#videoFrame").removeClass('col-md-12');
        $("#videoFrame").addClass('col-md-10');
        $("#infoFrame").addClass('col-md-2');
        $("#infoFrame").show();
        $("#arrowRight").show();
        $("#arrowLeft").hide();
        expand = true;
    }
}

function showTab(type){
    $(".txtTabs").removeClass("txtInactive");

    if(type == "transcript"){
        $("#transcripts").fadeIn();
        $("#notes").hide();
        $("#tabTranscripts").addClass("active");
        $("#tabTranscripts").removeClass("inactive");
        $("#tabNotes").removeClass("active");
        $("#tabNotes").addClass("inactive");
        $("#txtNotes").addClass("txtInactive");
    } else if(type == "notes"){
        $("#transcripts").hide();
        $("#notes").fadeIn();
        $("#tabNotes").removeClass("inactive");
        $("#tabNotes").addClass("active");
        $("#tabTranscripts").removeClass("active");
        $("#tabTranscripts").addClass("inactive");
        $("#txtTranscripts").addClass("txtInactive");
    }
}

function startAt(time) {
    let player = document.getElementById('screencastVideo').contentWindow.videojs.getPlayer("mp4Player");

    // If the time passed is a string containing a colon (h:m:s)
    // calculate the number of seconds that represents
    if (typeof time === 'string' && time.indexOf(':') > -1) {
        if (time.charAt(0) === ':') {
            // Strip a leading ':' character if we only have seconds
            time = time.substring(1);
        }

        // Split the time into an array and reverse so order is seconds, minutes, hours
        var segments = time.split(':').reverse();

        // Grab the seconds (we'll always have seconds)
        time = parseInt(segments[0]);

        // Add in the minutes
        if (segments.length > 1) {
            time += parseInt(segments[1]) * 60;
        }

        // Add in the hours
        if (segments.length === 3) {
            time += parseInt(segments[2]) * 3600;
        }
    }

    // Begin playback before setting time to coax Safari to jump to the correct time
    var startedAt = false;
    player.currentTime(time);
    if (!player.playing) {
        player.play();
        setTimeout(function() {
            player.currentTime(time);
            if (!player.playing) {
                // Kickstart playing (for Mac/iOS)
                player.on('canplaythrough', function() {
                    if (!startedAt) {
                        player.currentTime(time);
                        startedAt = true;
                    }
                });
            }
        }, 200);
        // if (!player.playing) {
        //     player.play();
        //     setTimeout(function() {
        //         player.currentTime(time);
        //     }, 250);
        // }
    }
}

function searchVideos(searchTerm){
    var content = '<div id="resultCount" class="resultCount"></div><table class="table table-responsive">';
    var resultCount = 0;
    for(var i = 0; i < videosObject.length; i++) {

        var obj = videosObject[i];
        var id = obj.id;
        var duration = obj.duration;
        var standardUrl = obj.standardUrl;
        var title = obj.title;
        var found = title.toLowerCase().includes(searchTerm.toLowerCase());
        if (found){
            resultCount++;
            content = content + '<tr id="' + id + '" class="selectVideo" onClick="selectVideo(\'' + id + '\');"><td><img src="' + standardUrl + '" class="imageThumb"></td><td>' + title + '</td><td style="padding-right: 5px;padding-left: 0;width: 100%;" align="right">' + duration + ' > </td></tr>';
        }
    }
    $("#searchList").html(content + "</table>");
    windowHeight = document.body.clientHeight - 75;
    $("#searchList").height(windowHeight);
    $("#resultCount").html(resultCount + ' videos found');

}

function changeTranscript(){
    prepareTranscripts($("#captionChoice").val());
}

function prepareTranscripts(url){
    var transcriptsContent = '<div class="col col-md-12">';

    $.ajax({
        method: "GET",
        url: url,
        success: function (response) {
            transcriptsContent = transcriptsContent + parseTranscripts(response);

            if(transcriptsContent == '<div class="col col-md-12">'){
                transcriptsContent = transcriptsContent + 'No transcriptions found';
            }
            transcriptsContent = transcriptsContent + '</div>';
            $('#transcriptData').html(transcriptsContent);
        }
    });

}

function parseTranscripts(string) {
    var content = line = startTime = text = misc = "";
    var lines = string.split("\n");

    if (lines[0] == '<!doctype html>'){
        // No captions found
        return "";
    }

    captionData = [];
    for (var i = 1; i < lines.length; i++) {
        startTime = "";
        text =  "";
        misc = parseInt(lines[i].trim().replace(/[^ -~]+/g, ""));
        if ((misc !== NaN && (misc + '') === lines[i].trim().replace(/[^ -~]+/g, "")) || lines[i].trim().length === 0) {
            // Line number or blank line
            if (i != 1 && i != lines.length - 1 && lines[i].trim().length === 0) {
                // Blank line - Close "section" with an HR
                text = text.trim().replace(/\>/g, "&gt;") + '<hr>';
                content = content + text;
            }
            // If we have a line that only contains a numeric value we ignore it
            continue;
        }

        line = lines[i];
        if (line.includes('-->')) {
            // The line is a time range - collect the starting time
            startTime = cleanTime(lines[i].split('-->')[0].trim());
        } else {
            // The line contains caption text
            text = line;
        }

        if (startTime != '') {
            content = content + `<a href="#" onClick="startAt('${startTime}')" class="font-weight-bold">${startTime}</a> `;
        }
        content += ' ' + text;
    }

    return content;
}


function printsize(){
    width = document.body.clientWidth;
    height = document.body.clientHeight;
    heightBanner = $(".advertBanner").height();
    topBar = $("#top-bar").height();
    publishBar = $(".publish-status-row").height();
    if(heightBanner >= 1){
        heightBanner += 30;
    } else {
        heightBanner = 0;
    }
    if(topBar == undefined){
        topBar = 0;
    }
    if(publishBar == undefined){
        publishBar = 0;
    }

    $("#videoFrame").height(height - topBar - heightBanner - publishBar);
    $("#infoFrame").height(height - topBar - heightBanner - publishBar);
}

function selectVideo(id){
    $(".selectVideo").removeClass('selectedVideo');
    $("#" + id).addClass('selectedVideo');
    window.location.href = '/watch/' + id;
}

function secToClock(seconds) {
    var minutes = Math.floor(seconds / 60);
    seconds = seconds % 60;
    if (seconds < 10) seconds = "0" + seconds;
    if (minutes == 0) minutes = "00";
    return minutes + ":" + seconds;
}

function cleanTime(time) {
    time = time.split('.')[0];
    while (time != (time = time.replace(/^(0:|00:)/g, '')));

    if (time.length < 3) {
        // If we only have seconds we want to return 0:SS
        time = '0:' + time.padStart(2, '0')
    } else if (time.charAt(0) === '0') {
        // Otherwise strip any leading zeros
        time = time.substring(1);
    }

    return time;
}
